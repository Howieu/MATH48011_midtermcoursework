# Semaglutide 数据分析 - 使用说明

## 文件说明

- **semaglutide_analysis.R**: 完整的 R 分析脚本
- **Semaglutide.csv**: 原始数据文件
- **IHC_lm-article-2025.pdf**: 课程讲义（所有方法均基于此讲义）

## 如何运行分析

### 步骤 1: 安装必要的 R 包

在 R 或 RStudio 中运行以下命令安装所需的包：

```r
install.packages("tidyverse")  # 包含 ggplot2, dplyr, readr 等
install.packages("broom")       # 用于整理模型输出
```

### 步骤 2: 运行分析脚本

有两种方式运行脚本：

**方式 1: 在 RStudio 中运行**
1. 在 RStudio 中打开 `semaglutide_analysis.R`
2. 确保工作目录设置为包含数据文件的目录
3. 点击 "Source" 按钮或按 Ctrl+Shift+S (Windows) / Cmd+Shift+S (Mac)

**方式 2: 在命令行中运行**
```bash
cd /path/to/MATH48011_midtermcoursework
Rscript semaglutide_analysis.R
```

### 步骤 3: 查看结果

脚本运行后会：
1. 在控制台输出所有分析结果
2. 在当前目录生成 8 张图表（PNG 格式）

## 生成的图表

脚本会自动生成以下图表文件：

1. **plot1_MWDR_vs_age.png**: MWDR vs. 年龄的散点图
2. **plot2_MWDR_vs_sex.png**: MWDR vs. 性别的箱形图
3. **plot3_MWDR_vs_age_by_sex.png**: 按性别分组的 MWDR vs. 年龄图（带二次拟合线）
4. **plot4_model_F_fitted_curves.png**: 模型 F 的拟合曲线
5. **plot4a_residuals_vs_fitted.png**: 残差 vs. 拟合值图（检查线性和方差齐性）
6. **plot4b_qq_plot.png**: 残差 Q-Q 图（检查正态性）
7. **plot4c_residuals_histogram.png**: 残差直方图
8. **plot6_prediction_interval.png**: 带 95% 预测区间的拟合图

## 作业问题对应

### 问题 1: 探索性图表
- 代码行: 20-90
- 生成图表: plot1, plot2, plot3
- 输出: 三张探索性图表及评论

### 问题 2: 拟合模型 F
- 代码行: 95-170
- 模型: E[Y] = θ₀ + θ₁x + θ₂x² + θ₃w + θ₄xw
- 输出:
  - 模型系数表
  - 拟合方程
  - 模型摘要统计
  - plot4: 拟合曲线图

### 问题 3: 解释参数
- 代码行: 175-205
- 输出: 对 θ₀, θ₀+θ₃, θ₄ 的详细解释

### 问题 4: 假设和图形诊断
- 代码行: 210-290
- 输出:
  - 四个假设的列表
  - plot4a: 残差 vs. 拟合值
  - plot4b: Q-Q 图
  - plot4c: 残差直方图
  - 每张图的诊断评论

### 问题 5: 假设检验 (H₀: θ₃ + 40θ₄ = 0)
- 代码行: 295-370
- 方法: 基于 lm-article Proposition 5.4 的 t 检验
- 输出:
  - 检验统计量
  - p 值
  - 临界值
  - 检验决策和结论
  - 95% 置信区间

### 问题 6: 预测和预测区间
- 代码行: 375-455
- 方法: 基于 lm-article Proposition 5.8
- 预测对象: x=22, w=0 (22 岁男性)
- 输出:
  - 点预测
  - 95% 预测区间
  - plot6: 带预测区间的图
  - 额外: 置信区间 vs. 预测区间的比较

## 关键统计概念

### 模型 F 的参数含义

```
E[Y] = θ₀ + θ₁x + θ₂x² + θ₃w + θ₄xw
```

其中:
- **x**: 年龄（连续变量）
- **w**: 性别虚拟变量（w=0 表示男性 M，w=1 表示女性 F）
- **Y**: MWDR（Mean Weekly Dose Ratio）

**参数解释**:
- **θ₀**: 0 岁男性的预期 MWDR
- **θ₁**: 年龄的线性效应（对男性）
- **θ₂**: 年龄的二次效应（对两性相同）
- **θ₃**: 0 岁时女性相对男性的差异（截距差异）
- **θ₄**: 年龄线性效应的性别差异（交互效应）

### 置信区间 vs. 预测区间

- **置信区间 (Confidence Interval)**: 用于估计总体平均响应 E[Y|x] 的区间
  - 较窄
  - 只考虑参数估计的不确定性

- **预测区间 (Prediction Interval)**: 用于预测单个新观测值的区间
  - 较宽
  - 考虑参数估计的不确定性 + 个体随机误差

公式（基于 lm-article Proposition 5.8）:
```
预测区间: ŷ ± t_{α/2;n-r} × ŝ√(1 + x̃ᵀ(XᵀX)⁻¹x̃)
                                ↑
                            额外的 1
```

## 理论依据

所有分析方法均严格遵循 **lm-article (IHC_lm-article-2025.pdf)** 讲义:

- **探索性图表**: 第 1.2.2 节（图形方法）
- **虚拟变量**: 第 1.6.1 节（分类变量的编码）
- **二次项**: 第 1.3.4 节（多项式回归）
- **交互项**: 第 1.7 节（ANCOVA）
- **模型诊断**: 第 3.4 节（残差诊断）
- **假设检验**: 第 5.2.1 节 + Proposition 5.4（线性组合的 t 检验）
- **预测区间**: 第 5.4 节 + Proposition 5.8（预测区间公式）

## 常见问题

**Q1: 为什么选择 F 为参考水平（w=1）而不是 M？**

A: 在代码中，我实际上选择了 M (男性) 作为参考水平 (w=0)，F (女性) 为 w=1。这样 θ₀ 表示男性的基线，θ₃ 表示女性相对于男性的差异，更直观。

**Q2: 如何理解交互项 θ₄？**

A: θ₄ 表示年龄对 MWDR 的线性效应在两性之间的差异。如果 θ₄ ≠ 0，说明年龄对 MWDR 的影响在男性和女性之间不同（即存在交互作用）。

**Q3: 为什么需要检查残差诊断？**

A: 线性回归的统计推断（t 检验、置信区间等）依赖于四个关键假设（正态性、方差齐性、独立性、结构正确）。残差诊断帮助我们验证这些假设是否合理。

**Q4: 预测区间为什么这么宽？**

A: 预测区间不仅考虑了我们对参数估计的不确定性，还考虑了个体观测值的随机误差 (σ²)。这使得预测区间总是比置信区间更宽。

## 技术细节

### tidyverse 的优势

1. **管道操作符** `%>%`: 使代码更易读
   ```r
   data %>% mutate(w = ifelse(sex == "F", 1, 0))
   ```

2. **broom::tidy()**: 将模型输出转换为整洁的数据框
   ```r
   tidy(fit_F)  # 替代 summary(fit_F)
   ```

3. **broom::augment()**: 获取拟合值和残差
   ```r
   diag_data <- augment(fit_F)
   ```

4. **ggplot2**: 强大的可视化
   ```r
   ggplot(data, aes(x = age, y = MWDR, color = sex)) +
     geom_point() +
     geom_smooth(method = "lm", formula = y ~ x + I(x^2))
   ```

### 模型拟合的 R 公式

```r
lm(MWDR ~ age + I(age^2) + w + age:w, data = data_with_dummy)
```

- `age`: 线性项
- `I(age^2)`: 二次项（`I()` 函数防止 `^` 被解释为交互）
- `w`: 虚拟变量
- `age:w`: 交互项

## 联系与支持

如果在运行脚本时遇到任何问题：
1. 确保所有必要的包已安装
2. 确保工作目录正确（数据文件在同一目录）
3. 检查 R 版本（建议 R ≥ 4.0.0）
4. 查看控制台的错误信息

祝分析顺利！
